{% extends 'AvanzuAdminThemeBundle:layout:base-layout.html.twig' %}
{% block page_content %}
    <div class="row">
        <div class="col-sm-8">&nbsp;</div>
        <div class="col-sm-4 ">
            <div id="reportrange" class="pull-right" style="background: #fff; cursor: pointer; padding: 5px 10px; border: 1px solid #ccc; width: 100%">
                <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>&nbsp;
                <span></span> <b class="caret"></b>
            </div>
        </div>
    </div>


    <div class="row">

        <div class="col-sm-12">
            <div class="box">
                <table class="table table-condensed">
                    <thead>
                    <tr>
                        <th>Budget Area</th>
                        <th>Templates</th>
                        <th>Average Fortnightly Spend</th>
                        <th>Average Fortnightly Positive</th>
                        <th>Average Fortnightly Income</th>
                        <th>Current Balance</th>
                        <th>Trend</th>
                        <th>Spend</th>
                    </tr>
                    </thead>
                    {% for budget in budgetaccounts %}
                        <tr {% if budget.budgetstats.overspend %}class="danger"{% endif %}>
                            <td>{{ budget.budgetname }}</td>
                            <td>{{ budget.TemplateTransactionsDescriptionsTooltip|raw }}</td>
                            <td>{{ budget.budgetstats.AverageFortnightlySpend |localizedcurrency('AUD') }}</td>
                            <td>{% if budget.budgetstats.AverageFortnightlyPositive %}{{ budget.budgetstats.AverageFortnightlyPositive |localizedcurrency('AUD') }}{% endif %}</td>
                            <td>{% if budget.budgetstats.AverageFortnightlyIncome %}{{ budget.budgetstats.AverageFortnightlyIncome |localizedcurrency('AUD') }}{% endif %}</td>
                            <td>
                                <span class="label {% if budget.balance < 0 %}label-danger{% elseif budget.balance == 0 %}label-warning{% else %}label-success{% endif %}">{{ budget.balance|localizedcurrency('AUD') }}</span>
                            </td>
                            <td>
                                <span class="sparkline"
                                      values="{{ budget.budgetstats.RunningTotalSparklineData }}"></span>
                            </td>
                            <td>
                                <span class="sparkline"
                                      values="{{ budget.budgetstats.WeekSpendSparklineData }}"></span>
                            </td>

                        </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
    </div><!-- row -->

{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('bundles/avanzuadmintheme/vendor/adminlte/plugins/sparkline/jquery.sparkline.js') }}"></script>
    <script type="text/javascript">

        if (moment().quarter() == 4 || moment().quarter() == 3) {
            var current_fiscal_year_start = moment().month('July').startOf('month');
            var current_fiscal_year_end = moment().add('year', 1).month('June').endOf('month');
            var last_fiscal_year_start = moment().subtract('year', 1).month('July').startOf('month');
            var last_fiscal_year_end = moment().month('June').endOf('month');
        } else {
            var current_fiscal_year_start = moment().subtract('year', 1).month('July').startOf('month');
            var current_fiscal_year_end = moment().month('June').endOf('month');
            var last_fiscal_year_start = moment().subtract('year', 2).month('July').startOf('month');
            var last_fiscal_year_end = moment().subtract('year', 1).month('June').endOf('month');
        };

        $(function() {

            function cb(start, end) {
                $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            }
            cb(moment('{{ startdate | date('Ymd') }}', 'YYYYMMDD'), moment('{{ enddate | date('Ymd') }}', 'YYYYMMDD'));

            $('#reportrange').daterangepicker({
                showDropdowns: true,
                startDate: moment('{{ startdate | date('Ymd') }}', 'YYYYMMDD'),
                endDate: moment('{{ enddate | date('Ymd') }}', 'YYYYMMDD'),

                ranges: {
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                    'This Quarter': [moment().startOf('quarter'), moment().endOf('quarter')],
                    'Last Quarter': [moment().subtract(3, 'M').startOf('quarter'), moment().subtract(3, 'M').endOf('quarter')],
                    'This Year': [moment().startOf('year'), moment().endOf('year')],
                    'Last year': [moment().startOf('year').subtract(1, 'y'), moment().endOf('year').subtract(1, 'y')],
                    'This Financial Year': [current_fiscal_year_start, current_fiscal_year_end],
                    'Last Financial year': [last_fiscal_year_start, last_fiscal_year_end],

                },
                alwaysShowCalendars: true,
            }, cb);

            $('#reportrange').on('apply.daterangepicker', function(ev, picker) {
                window.location = window.location.pathname + "?startdate=" + encodeURIComponent(picker.startDate.format('YYYY-MM-DD')) + '&enddate=' + encodeURIComponent(picker.endDate.format('YYYY-MM-DD'));
            });

        });
    </script>
{% endblock %}


{% block javascripts_inline %}
    <script>
        $('.sparkline').sparkline('html', {valueSpots: {'1:': 'green', ':-1': 'red'}, height: '4em', width: '15em'});
    </script>
{% endblock %}